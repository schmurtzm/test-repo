name: Generate a table of PNG images in directories

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Create table of images
      run: |
        echo "| Directory | Image | Size |" > Table.md
        echo "| :--------: | :---: | :--: |" >> Table.md
        for dir in $(find . -type d -print); do
          if [ -d "$dir/Roms/PORTS/Imgs" ]; then
            image=$(find "$dir/Roms/PORTS/Imgs" -maxdepth 1 -type f -name "*.png")
            if [ -n "$image" ]; then
              name=$(basename "$dir")
              release=$(curl -s https://api.github.com/repos/$GITHUB_REPOSITORY/releases/latest | jq -r '.assets[] | select(.name | contains("'"$name"'")) | .browser_download_url')
              size=$(curl -sI "$release" | awk '/Content-Length/ {size=int($2/1024) "KB"} END {print size}')
              convert "$image" -resize x200 "$(dirname "$image")/thumbnail_$(basename "$image")"
              thumbnail="$(dirname "$image")/thumbnail_$(basename "$image")"
              echo "| [$name]($release) | [![image]($thumbnail)]($release) | $size |" >> Table.md
              echo "Added image $thumbnail from release $release with size $size"
            fi
          fi
        done
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Table.md
        git commit -m "Add table of PNG images in directories"
        git push
